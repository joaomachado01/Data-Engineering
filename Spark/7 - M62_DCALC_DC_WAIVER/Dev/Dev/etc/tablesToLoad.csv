m62_great.tbl_calc_dc_waiver;SELECT di_ndema, di_ldoss, tci_craf, dt_val_dc, dat_val_conc, lib_nouvelle_conc FROM ( SELECT tiers.di_ndema AS di_ndema, dossier.di_ldoss AS di_ldoss, tiers.tci_craf AS tci_craf, dossier.ag_dec_dcrea AS dt_val_dc, concession.vdate AS dat_val_conc, dossier.dc_nconc AS lib_nouvelle_conc, dossier.key_partition, RANK() OVER(PARTITION BY tiers.tci_craf ORDER BY dossier.ag_dec_dcrea DESC, concession.vdate DESC) AS rank_ FROM m62_great.tbl_rep_dc_tiers tiers LEFT JOIN m62_great.tbl_rep_dc_dossier dossier ON (tiers.di_ndema=dossier.di_ndema AND tiers.key_partition=dossier.key_partition) LEFT JOIN m62_great.tbl_rep_dc_concession concession ON (dossier.di_ndema=concession.di_ndema AND dossier.key_partition=concession.key_partition) LEFT JOIN m62_great.tbl_rep_dc_concession_type concession_type ON (dossier.di_ndema=concession_type.di_ndema AND concession.c_id=concession_type.c_id AND concession.key_partition=concession_type.key_partition) WHERE tiers.key_partition = '[KP]' AND UPPER(dossier.di_statu) <> 'ABA' AND concession.c_id IS NOT NULL AND UPPER(concession_type.cty_id) = 'LT7' AND dossier.ag_dec_dcrea IS NOT NULL AND concession.vdate IS NOT NULL ORDER BY tiers.tci_craf, tiers.di_ndema, concession.c_id 	) main WHERE rank_ = 1;